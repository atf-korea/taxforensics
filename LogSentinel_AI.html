
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LogSentinel AI - Forensic Analyzer</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      background-color: #020617; 
      color: #e2e8f0; 
      overflow: hidden; 
    }
    .font-mono { font-family: 'JetBrains Mono', monospace; }
    
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }
    
    .animate-fade-in { animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #020617; z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.5s;
    }
    
    /* Loading Log Console */
    .log-console {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: #64748b;
      margin-top: 20px;
      text-align: center;
      line-height: 1.5;
    }
  </style>

  <!-- Load Libraries via CDN (Cloudflare/JSDelivr for stability) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.12.0/umd/Recharts.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.1",
    "react-dom/": "https://esm.sh/react-dom@^19.2.1/",
    "react/": "https://esm.sh/react@^19.2.1/",
    "lucide-react": "https://esm.sh/lucide-react@^0.559.0",
    "@google/genai": "https://esm.sh/@google/genai@^1.32.0",
    "recharts": "https://esm.sh/recharts@^3.5.1"
  }
}
</script>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-overlay">
    <svg class="w-12 h-12 text-cyan-500 animate-spin mb-4" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <h2 class="text-xl font-bold text-white">LogSentinel 가동 중...</h2>
    <div id="loading-log" class="log-console">시스템 초기화 대기 중...</div>
  </div>

  <div id="root" class="h-screen w-screen"></div>

  <script>
    // System Logger
    function log(msg) {
      const el = document.getElementById('loading-log');
      if(el) el.innerText = msg;
      console.log(`[System] ${msg}`);
    }

    // Safety Loader
    function waitForGlobals() {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        const interval = setInterval(() => {
          attempts++;
          const hasReact = !!window.React;
          const hasReactDOM = !!window.ReactDOM;
          const hasRecharts = !!window.Recharts;

          log(`모듈 로딩 중... React:${hasReact} Recharts:${hasRecharts} (${attempts})`);

          if (hasReact && hasReactDOM && hasRecharts) {
            clearInterval(interval);
            resolve();
          } else if (attempts > 100) { // 10 seconds timeout
            clearInterval(interval);
            if (hasReact && hasReactDOM) {
              log("경고: 차트 라이브러리 로딩 실패. 일부 기능이 제한됩니다.");
              resolve(); // Proceed anyway
            } else {
              reject("핵심 라이브러리 로딩 실패. 인터넷 연결을 확인하세요.");
            }
          }
        }, 100);
      });
    }
  </script>

  <script type="text/babel">
    // Main Entry Point
    waitForGlobals().then(() => {
      const overlay = document.getElementById('loading-overlay');
      if(overlay) overlay.style.opacity = '0';
      setTimeout(() => overlay?.remove(), 500);

      const { useState, useEffect, useMemo, useRef } = React;
      
      // Safe destructuring of Recharts
      const Recharts = window.Recharts || {};
      const { 
        BarChart, Bar, LineChart, Line, PieChart, Pie, Cell, 
        XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer 
      } = Recharts;

      /* ---------------------------------------------------------------------------
       *  ICONS (Inline SVG)
       * --------------------------------------------------------------------------- */
      const Icons = {
        Activity: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
        LayoutDashboard: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></svg>,
        ShieldAlert: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
        BrainCircuit: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/></svg>,
        FileText: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
        UploadCloud: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>,
        Usb: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="10" cy="7" r="1"/><circle cx="4" cy="20" r="1"/><path d="M4.7 19.3 19 5"/><path d="m21 3-3 1 2 2Z"/><path d="M9.26 7.68 5.99 13.44"/><path d="M5 16c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2"/></svg>,
        FolderOpen: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h3.93a2 2 0 0 1 1.66.9l.82 1.2a2 2 0 0 0 1.66.9H18a2 2 0 0 1 2 2v2"/></svg>,
        Search: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
        Sparkles: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275Z"/></svg>,
        Key: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/><line x1="7.5" y1="15.5" x2="7.55" y2="15.5"/></svg>,
        Save: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
        Send: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
        Terminal: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>,
        Download: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
        ScanSearch: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><circle cx="12" cy="12" r="3"/><path d="m16 16-1.9-1.9"/></svg>,
        Play: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
        LogOut: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
        Loader: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={p.className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
        FileJson: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
        Bot: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2 2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/><path d="M4 8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8z"/><path d="M9 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/><path d="M15 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>,
        User: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
        ExternalLink: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
        CheckCircle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
        Clock: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
        AlertTriangle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
        Coffee: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>
      };

      /* ---------------------------------------------------------------------------
       *  DATA & SERVICES
       * --------------------------------------------------------------------------- */
      // Mock Data Generator
      const generateMockData = () => {
        const apps = [
          { name: 'VS Code', category: 'Development' }, { name: 'Chrome', category: 'Uncategorized' },
          { name: 'Slack', category: 'Communication' }, { name: 'Spotify', category: 'Entertainment' },
          { name: 'Excel', category: 'Productivity' }, { name: 'Figma', category: 'Productivity' }
        ];
        return Array.from({length: 50}, (_, i) => {
          const app = apps[Math.floor(Math.random() * apps.length)];
          return {
            id: i.toString(),
            timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 3600 * 1000).toISOString(),
            application: app.name,
            windowTitle: `Active Window - ${app.name}`,
            durationSeconds: Math.floor(Math.random() * 1800) + 60,
            category: app.category
          };
        }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      };

      const generateForensicArtifacts = () => [
        { id: '1', timestamp: new Date().toISOString(), type: 'USB_DEVICE', name: 'Samsung T7 (Demo)', path: 'USBSTOR\\Disk&Ven_Samsung', action: 'Connected', riskLevel: 'LOW' },
        { id: '2', timestamp: new Date().toISOString(), type: 'RECENT_DOC', name: 'Secret_Plans.docx (Demo)', path: 'C:\\Users\\Admin\\Desktop\\Secret_Plans.docx', action: 'Accessed', riskLevel: 'HIGH' },
        { id: '3', timestamp: new Date().toISOString(), type: 'SHELLBAG', name: 'Private_Photos (Demo)', path: 'E:\\Private_Photos', action: 'Folder Explored', riskLevel: 'MEDIUM' }
      ];

      // AI Service (Fetch)
      const analyzeLogsWithGemini = async (logs, artifacts, userPrompt, apiKey) => {
        if (!apiKey) throw new Error("API Key가 필요합니다.");
        const summary = `Logs Count: ${logs.length}. Artifacts: ${artifacts.length}. High Risk: ${artifacts.filter(a=>a.riskLevel==='HIGH').map(a=>a.name).join(', ')}`;

        try {
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: `System: 당신은 디지털 포렌식 전문가입니다. 다음 데이터를 바탕으로 답변하세요.\nContext: ${summary}\nUser: ${userPrompt}` }] }]
            })
          });
          if (!response.ok) throw new Error(`API Error: ${response.status}`);
          const data = await response.json();
          return data.candidates?.[0]?.content?.parts?.[0]?.text || "응답을 생성하지 못했습니다.";
        } catch (e) {
          throw new Error("AI 통신 실패: " + e.message);
        }
      };

      /* ---------------------------------------------------------------------------
       *  COMPONENTS
       * --------------------------------------------------------------------------- */
      // 1. Dashboard
      const Dashboard = ({ logs }) => {
        const stats = useMemo(() => {
          const total = logs.reduce((acc, l) => acc + l.durationSeconds, 0);
          const appMap = {};
          logs.forEach(l => { appMap[l.application] = (appMap[l.application] || 0) + l.durationSeconds; });
          const topApps = Object.entries(appMap).map(([name, dur]) => ({ name, duration: Math.round(dur/60) })).sort((a, b) => b.duration - a.duration).slice(0, 5);
          return { totalHours: (total/3600).toFixed(1), topApps };
        }, [logs]);

        if (!BarChart) return <div className="text-red-400 p-4 border border-red-900 rounded bg-red-900/10">차트 라이브러리가 로드되지 않았습니다.</div>;

        return (
          <div className="space-y-6 animate-fade-in">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="bg-slate-900 border border-slate-800 p-6 rounded-xl relative overflow-hidden">
                <Icons.Clock className="absolute right-4 top-4 w-12 h-12 text-slate-800" />
                <h3 className="text-slate-400 text-sm font-medium">총 분석 시간</h3>
                <p className="text-3xl font-bold text-white mt-2">{stats.totalHours} <span className="text-lg text-slate-500">시간</span></p>
              </div>
              <div className="bg-slate-900 border border-slate-800 p-6 rounded-xl relative overflow-hidden">
                <Icons.Activity className="absolute right-4 top-4 w-12 h-12 text-slate-800" />
                <h3 className="text-slate-400 text-sm font-medium">이벤트 수</h3>
                <p className="text-3xl font-bold text-cyan-400 mt-2">{logs.length}</p>
              </div>
            </div>
            <div className="bg-slate-900 border border-slate-800 p-6 rounded-xl h-80">
              <h3 className="text-white mb-4 font-semibold">상위 애플리케이션 (분)</h3>
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={stats.topApps} layout="vertical" margin={{top:5, right:30, left:40, bottom:5}}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#334155" horizontal={false}/>
                  <XAxis type="number" stroke="#94a3b8" />
                  <YAxis dataKey="name" type="category" stroke="#94a3b8" width={100} />
                  <Tooltip contentStyle={{backgroundColor: '#1e293b', borderColor: '#334155', color: '#fff'}} />
                  <Bar dataKey="duration" fill="#22d3ee" radius={[0,4,4,0]} barSize={20} />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>
        );
      };

      // 2. Forensics View
      const ForensicsView = ({ artifacts }) => {
        const [filter, setFilter] = useState('ALL');
        const filtered = artifacts.filter(a => filter === 'ALL' || a.type === filter);
        return (
          <div className="space-y-6 animate-fade-in">
            <div className="flex gap-2">
              {['ALL', 'USB_DEVICE', 'RECENT_DOC', 'SHELLBAG'].map(t => (
                <button key={t} onClick={() => setFilter(t)} className={`px-4 py-2 rounded-lg text-sm font-bold ${filter === t ? 'bg-cyan-600 text-white' : 'bg-slate-800 text-slate-400'}`}>
                  {t === 'ALL' ? '전체' : t}
                </button>
              ))}
            </div>
            <div className="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
              <table className="w-full text-left text-sm text-slate-400">
                <thead className="bg-slate-950 text-slate-500 uppercase font-bold text-xs">
                  <tr><th className="p-4">유형</th><th className="p-4">이름</th><th className="p-4">경로/상세</th><th className="p-4">위험도</th></tr>
                </thead>
                <tbody className="divide-y divide-slate-800">
                  {filtered.map((a, i) => (
                    <tr key={i} className="hover:bg-slate-800/50">
                      <td className="p-4 flex items-center gap-2 text-white">
                        {a.type === 'USB_DEVICE' ? <Icons.Usb className="w-4 h-4 text-blue-400"/> :
                         a.type === 'RECENT_DOC' ? <Icons.FileText className="w-4 h-4 text-green-400"/> :
                         <Icons.FolderOpen className="w-4 h-4 text-yellow-400"/>}
                        {a.type}
                      </td>
                      <td className="p-4 text-white font-medium">{a.name}</td>
                      <td className="p-4 font-mono text-xs max-w-xs truncate">{a.path}</td>
                      <td className="p-4"><span className={`px-2 py-1 rounded text-xs ${a.riskLevel === 'HIGH' ? 'bg-red-500/20 text-red-400' : 'bg-slate-700 text-slate-300'}`}>{a.riskLevel}</span></td>
                    </tr>
                  ))}
                  {filtered.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-slate-600">데이터가 없습니다.</td></tr>}
                </tbody>
              </table>
            </div>
          </div>
        );
      };

      // 3. AI Analysis
      const AIAnalysis = ({ logs, artifacts }) => {
        const [messages, setMessages] = useState([{ role: 'ai', content: '데이터 분석 준비 완료. 질문해 주세요.' }]);
        const [input, setInput] = useState('');
        const [loading, setLoading] = useState(false);
        const [apiKey, setApiKey] = useState(() => localStorage.getItem('GEMINI_API_KEY') || '');
        const [showKeyInput, setShowKeyInput] = useState(!apiKey);
        const [tempKey, setTempKey] = useState('');
        const scrollRef = useRef(null);

        useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [messages]);

        const handleSaveKey = () => {
          if(tempKey.trim()) {
            localStorage.setItem('GEMINI_API_KEY', tempKey.trim());
            setApiKey(tempKey.trim());
            setShowKeyInput(false);
          }
        };

        const handleSend = async () => {
          if (!input.trim() || loading) return;
          if (!apiKey) { setShowKeyInput(true); return; }
          const userMsg = { role: 'user', content: input };
          setMessages(prev => [...prev, userMsg]);
          setInput('');
          setLoading(true);
          try {
            const responseText = await analyzeLogsWithGemini(logs, artifacts, userMsg.content, apiKey);
            setMessages(prev => [...prev, { role: 'ai', content: responseText }]);
          } catch (e) {
            setMessages(prev => [...prev, { role: 'ai', content: `오류: ${e.message}` }]);
          } finally {
            setLoading(false);
          }
        };

        return (
          <div className="flex flex-col h-[600px] bg-slate-900 border border-slate-800 rounded-xl overflow-hidden animate-fade-in">
            <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-800/50">
              <div className="flex items-center gap-2 font-bold text-white"><Icons.Sparkles className="text-cyan-400 w-5 h-5"/> Gemini AI</div>
              <button onClick={() => setShowKeyInput(!showKeyInput)} className="text-xs flex items-center gap-1 bg-slate-800 px-3 py-1 rounded text-slate-300 border border-slate-700 hover:text-white">
                <Icons.Key className="w-3 h-3"/> {apiKey ? '키 변경' : '키 설정'}
              </button>
            </div>
            {showKeyInput && (
              <div className="p-4 bg-slate-800 space-y-3 animate-fade-in border-b border-slate-700">
                <div className="flex gap-2">
                  <input type="password" placeholder="Gemini API Key 입력" value={tempKey} onChange={e=>setTempKey(e.target.value)} className="flex-1 bg-slate-950 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-cyan-500 outline-none"/>
                  <button onClick={handleSaveKey} className="bg-cyan-600 text-white px-4 py-2 rounded text-sm flex items-center gap-1"><Icons.Save className="w-3 h-3"/>저장</button>
                </div>
                <div className="text-xs text-slate-400 flex items-center gap-1">
                   키가 없으신가요? 
                   <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-cyan-400 hover:underline flex items-center gap-1">
                     Google AI Studio에서 키 발급받기 <Icons.ExternalLink className="w-3 h-3"/>
                   </a>
                </div>
              </div>
            )}
            <div className="flex-1 overflow-y-auto p-4 space-y-4" ref={scrollRef}>
              {messages.map((m, i) => (
                <div key={i} className={`flex gap-3 ${m.role === 'user' ? 'flex-row-reverse' : ''}`}>
                   <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${m.role === 'user' ? 'bg-indigo-500/20 text-indigo-400' : 'bg-cyan-500/20 text-cyan-400'}`}>
                      {m.role === 'user' ? <Icons.User className="w-5 h-5"/> : <Icons.Bot className="w-5 h-5"/>}
                   </div>
                  <div className={`p-3 rounded-lg max-w-[80%] text-sm whitespace-pre-wrap ${m.role === 'user' ? 'bg-indigo-600/20 text-indigo-100 border border-indigo-500/20' : 'bg-slate-800 text-slate-200 border border-slate-700'}`}>
                    {m.content}
                  </div>
                </div>
              ))}
              {loading && <div className="text-slate-500 text-sm ml-12 flex items-center gap-2"><Icons.Loader className="w-4 h-4 animate-spin"/> 분석 중...</div>}
            </div>
            <div className="p-4 bg-slate-800/50 border-t border-slate-800 flex gap-2">
              <input className="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:border-cyan-500 outline-none" 
                     placeholder={apiKey ? "질문을 입력하세요..." : "API Key를 먼저 설정하세요"} 
                     value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()} 
                     disabled={loading} />
              <button onClick={handleSend} disabled={loading} className="bg-cyan-600 text-white p-2 rounded-lg hover:bg-cyan-500 disabled:opacity-50"><Icons.Send className="w-5 h-5"/></button>
            </div>
          </div>
        );
      };

      // 4. File Upload & Script Generation
      const FileUpload = ({ onUpload, onStartSim, onDownloadScript }) => {
        const fileInputRef = useRef(null);
        const [isDragging, setIsDragging] = useState(false);
        const [error, setError] = useState(null);
        const [tempData, setTempData] = useState(null);

        const parseJSON = (text, fileName) => {
          try {
            const data = JSON.parse(text);
            let logs = [], artifacts = [];
            
            if (Array.isArray(data)) {
               logs = data;
            } else if (data.logs || data.artifacts) {
               logs = data.logs || [];
               artifacts = data.artifacts || [];
            } else {
               throw new Error("Invalid Format");
            }
            setTempData({ logs, artifacts, fileName });
            setError(null);
          } catch(e) {
            setError("파일 파싱 실패: 올바른 JSON 형식이 아닙니다.");
            setTempData(null);
          }
        };

        const handleFile = (e) => { const file = e.target.files?.[0]; if(file) readFile(file); };
        const handleDrop = (e) => { e.preventDefault(); setIsDragging(false); const file = e.dataTransfer.files?.[0]; if(file) readFile(file); };
        const readFile = (file) => { const reader = new FileReader(); reader.onload = (e) => parseJSON(e.target.result, file.name); reader.readAsText(file); };
        
        return (
          <div className="max-w-4xl mx-auto space-y-8 mt-10 animate-fade-in">
            <div className="text-center space-y-4">
              <h1 className="text-4xl font-bold text-white">LogSentinel AI</h1>
              <p className="text-slate-400">PC 포렌식 및 로그 분석 시스템</p>
            </div>

            <div className="bg-slate-900 border border-slate-800 p-8 rounded-xl space-y-6 shadow-2xl">
              {!tempData ? (
                <div 
                  className={`border-2 border-dashed rounded-xl p-10 flex flex-col items-center cursor-pointer transition-colors ${isDragging ? 'border-cyan-500 bg-cyan-500/10' : 'border-slate-700 hover:border-slate-500'}`}
                  onDragOver={(e)=>{e.preventDefault(); setIsDragging(true)}}
                  onDragLeave={()=>setIsDragging(false)}
                  onDrop={handleDrop}
                  onClick={()=>fileInputRef.current?.click()}
                >
                  <input type="file" ref={fileInputRef} onChange={handleFile} className="hidden" accept=".json"/>
                  <Icons.UploadCloud className="w-12 h-12 mb-4 text-cyan-500"/>
                  <p className="text-slate-300 font-bold text-lg">파일 업로드</p>
                  <p className="text-slate-500 text-sm">JSON 로그 파일을 드래그하거나 클릭하세요</p>
                  {error && <p className="text-red-400 mt-4 text-sm bg-red-900/20 px-3 py-1 rounded">{error}</p>}
                </div>
              ) : (
                <div className="border border-cyan-500/30 bg-cyan-500/5 rounded-xl p-8 flex flex-col items-center text-center animate-fade-in">
                  <Icons.CheckCircle className="w-12 h-12 text-green-500 mb-4"/>
                  <h3 className="text-xl font-bold text-white mb-2">파일 준비 완료</h3>
                  <p className="text-cyan-300 mb-6 font-mono text-sm">{tempData.fileName}</p>
                  <div className="flex gap-4">
                    <button onClick={() => onUpload(tempData.logs, tempData.artifacts)} className="bg-cyan-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-cyan-500 flex items-center gap-2 shadow-lg shadow-cyan-500/20">
                      <Icons.ScanSearch className="w-5 h-5"/> 포렌식 분석 시작
                    </button>
                    <button onClick={() => setTempData(null)} className="bg-slate-800 text-slate-400 px-6 py-3 rounded-xl hover:text-white">취소</button>
                  </div>
                </div>
              )}

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-slate-800">
                <button onClick={onStartSim} className="bg-slate-800 text-slate-300 p-4 rounded-xl border border-slate-700 hover:bg-slate-700 flex items-center justify-center gap-2 hover:text-white transition-colors">
                  <Icons.Play className="w-5 h-5"/> 데모 데이터로 실행
                </button>
                <button onClick={onDownloadScript} className="bg-slate-800 text-slate-300 p-4 rounded-xl border border-slate-700 hover:bg-slate-700 flex items-center justify-center gap-2 hover:text-white transition-colors">
                  <Icons.Terminal className="w-5 h-5"/> 수집 스크립트(.ps1) 다운로드
                </button>
              </div>
            </div>
          </div>
        );
      };

      // 5. Main App Logic
      const App = () => {
        const [view, setView] = useState('UPLOAD');
        const [logs, setLogs] = useState([]);
        const [artifacts, setArtifacts] = useState([]);
        const [scanning, setScanning] = useState(false);
        const [scanStep, setScanStep] = useState(0);

        const startScanSequence = (targetLogs, targetArtifacts) => {
          setScanning(true);
          setScanStep(0);
          const steps = [
             () => setScanStep(1), () => setScanStep(2), () => setScanStep(3), () => setScanStep(4),
             () => {
               setLogs(targetLogs);
               setArtifacts(targetArtifacts);
               setScanning(false);
               setView(targetArtifacts.length > 0 ? 'FORENSICS' : 'DASHBOARD');
             }
          ];
          let current = 0;
          const interval = setInterval(() => {
            if (current < steps.length) { steps[current](); current++; } else { clearInterval(interval); }
          }, 800);
        };

        const handleDownloadScript = () => {
          // ADVANCED POWERSHELL SCRIPT
          const script = `
$ErrorActionPreference = "SilentlyContinue"
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
Write-Host "Starting Advanced Forensic Collection..." -ForegroundColor Cyan

$data = @{ logs = @(); artifacts = @() }

# 1. Recent Docs (Target Parsing)
Write-Host "[-] Scanning Recent Docs..."
$recentPath = "$env:APPDATA\\Microsoft\\Windows\\Recent"
if (Test-Path $recentPath) {
    try {
        $wsh = New-Object -ComObject WScript.Shell
        Get-ChildItem $recentPath -Filter "*.lnk" | Select-Object -First 30 | ForEach-Object {
            try {
                $lnk = $wsh.CreateShortcut($_.FullName)
                if ($lnk.TargetPath) {
                    $data.artifacts += @{
                        id = [Guid]::NewGuid().ToString(); type = "RECENT_DOC";
                        timestamp = $_.LastAccessTime.ToString("o");
                        name = $_.Name.Replace(".lnk",""); path = $lnk.TargetPath;
                        action = "Accessed"; riskLevel = "UNKNOWN"
                    }
                }
            } catch {}
        }
    } catch {}
}

# 2. Shellbags (TypedPaths)
Write-Host "[-] Scanning Shellbags..."
$regPath = "HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\TypedPaths"
if (Test-Path $regPath) {
    Get-ItemProperty $regPath | Get-Member -MemberType NoteProperty | Where-Object { $_.Name -match "^url" } | ForEach-Object {
        $val = (Get-ItemProperty $regPath).($_.Name)
        if ($val) {
             $data.artifacts += @{
                id = [Guid]::NewGuid().ToString(); type = "SHELLBAG";
                timestamp = (Get-Date).ToString("o");
                name = "Typed Path"; path = $val;
                action = "Explorer Navigation"; riskLevel = "MEDIUM"
            }
        }
    }
}

# 3. USB History
Write-Host "[-] Scanning USB..."
Get-PnpDevice -Class 'USB' -Status OK | Where-Object { $_.FriendlyName -notmatch 'Hub|Controller' } | ForEach-Object {
    $data.artifacts += @{
        id = [Guid]::NewGuid().ToString(); type = "USB_DEVICE";
        timestamp = (Get-Date).ToString("o");
        name = $_.FriendlyName; path = $_.InstanceId;
        action = "Connected"; riskLevel = "LOW"
    }
}

# 4. Folder Access
$roots = @("Desktop", "Downloads", "Documents")
foreach ($r in $roots) {
    $p = "$env:USERPROFILE\\$r"
    if (Test-Path $p) {
        Get-ChildItem $p -Directory | Where-Object { $_.LastAccessTime -gt (Get-Date).AddDays(-7) } | ForEach-Object {
             $data.artifacts += @{
                id = [Guid]::NewGuid().ToString(); type = "SHELLBAG";
                timestamp = $_.LastAccessTime.ToString("o");
                name = $_.Name; path = $_.FullName;
                action = "Folder Accessed"; riskLevel = "LOW"
            }
        }
    }
}

$outFile = "$PWD\\forensics_data.json"
$data | ConvertTo-Json -Depth 5 -Compress | Out-File $outFile -Encoding utf8
Write-Host "[+] Saved to $outFile" -ForegroundColor Green
Start-Sleep -Seconds 3
`;
          const blob = new Blob([script], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'collect_data.ps1';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        };

        if(scanning) {
           const msgs = ["시스템 초기화...", "로그 분석 중...", "Shellbag 아티팩트 스캔...", "USB 히스토리 복원 중...", "최근 문서 접근 기록 추출...", "완료"];
           return (
            <div className="h-screen bg-slate-950 flex flex-col items-center justify-center text-white space-y-8">
              <div className="relative w-24 h-24">
                 <div className="absolute inset-0 border-4 border-slate-800 rounded-full"></div>
                 <div className="absolute inset-0 border-4 border-cyan-500 rounded-full border-t-transparent animate-spin"></div>
                 <div className="absolute inset-0 flex items-center justify-center text-cyan-400"><Icons.Activity className="w-8 h-8"/></div>
              </div>
              <div className="text-center">
                <h2 className="text-2xl font-bold mb-2">System Forensic Scan</h2>
                <p className="text-cyan-400 font-mono text-sm min-h-[20px]">{msgs[scanStep]}</p>
              </div>
              <div className="w-64 bg-slate-900 rounded-full h-1"><div className="bg-cyan-500 h-full transition-all duration-300" style={{width: `${(scanStep/5)*100}%`}}></div></div>
            </div>
           );
        }

        return (
          <div className="flex h-screen bg-slate-950 text-slate-100 overflow-hidden">
            <aside className="w-64 bg-slate-900 border-r border-slate-800 flex flex-col z-10">
              <div className="p-6 border-b border-slate-800 flex items-center gap-2 text-cyan-400 font-bold text-xl"><Icons.Activity className="w-6 h-6"/> LogSentinel</div>
              <nav className="flex-1 p-4 space-y-2">
                <button onClick={() => setView('UPLOAD')} className={`flex items-center gap-3 w-full p-3 rounded-lg ${view === 'UPLOAD' ? 'bg-cyan-500/10 text-cyan-400' : 'text-slate-400 hover:text-white'}`}><Icons.UploadCloud className="w-5 h-5"/> 메인</button>
                {(logs.length > 0) && <>
                  <button onClick={() => setView('DASHBOARD')} className={`flex items-center gap-3 w-full p-3 rounded-lg ${view === 'DASHBOARD' ? 'bg-cyan-500/10 text-cyan-400' : 'text-slate-400 hover:text-white'}`}><Icons.LayoutDashboard className="w-5 h-5"/> 대시보드</button>
                  <button onClick={() => setView('FORENSICS')} className={`flex items-center gap-3 w-full p-3 rounded-lg ${view === 'FORENSICS' ? 'bg-red-500/10 text-red-400' : 'text-slate-400 hover:text-white'}`}><Icons.ShieldAlert className="w-5 h-5"/> 포렌식 결과</button>
                  <button onClick={() => setView('ANALYSIS')} className={`flex items-center gap-3 w-full p-3 rounded-lg ${view === 'ANALYSIS' ? 'bg-cyan-500/10 text-cyan-400' : 'text-slate-400 hover:text-white'}`}><Icons.BrainCircuit className="w-5 h-5"/> AI 분석</button>
                </>}
              </nav>
              <div className="p-4 border-t border-slate-800">
                <button onClick={() => window.location.reload()} className="flex items-center gap-3 w-full p-3 rounded-lg text-slate-400 hover:bg-slate-800"><Icons.LogOut className="w-5 h-5"/> 초기화</button>
              </div>
            </aside>
            <main className="flex-1 overflow-auto bg-slate-950 p-8 relative">
              {view === 'UPLOAD' && <FileUpload onUpload={startScanSequence} onStartSim={() => startScanSequence(generateMockData(), generateForensicArtifacts())} onDownloadScript={handleDownloadScript}/>}
              {view === 'DASHBOARD' && <Dashboard logs={logs}/>}
              {view === 'FORENSICS' && <ForensicsView artifacts={artifacts}/>}
              {view === 'ANALYSIS' && <AIAnalysis logs={logs} artifacts={artifacts}/>}
            </main>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    });
  </script>
</body>
</html>
